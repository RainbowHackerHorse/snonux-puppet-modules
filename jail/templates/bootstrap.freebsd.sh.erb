#!/usr/bin/env bash
# Created by Puppet

declare -r TMPDIR=<%= @tmpdir %>
declare -r MIRROR=<%= @mirror %>
declare -r REMOTE_PATH=<%= @remote_path %>
declare -r MOUNTPOINT=<%= @mountpoint %>

function checksum_dist {
  local -r dist=$1 ; shift

  if [ -f "$dist" ]; then
    local -r sha256=$(awk "\$1 ~ /^$dist\$/ { print \$2 }" MANIFEST)
    local -r sha256_now=$(sha256 -q $dist)
    [ $sha256 = $sha256_now ] && return 0
  fi

  return 1
}

function install_dist {
  local -r dist=$1 ; shift
  local -r okfile=$MOUNTPOINT/var/jailbootstrap.$dist.ok

  if [ ! -f $okfile ]; then
    tar -xpf $dist -C $MOUNTPOINT && touch $okfile
  fi
}

function fetch_dist {
  local -r dist=$1 ; shift
  local -r okfile=$MOUNTPOINT/var/jailbootstrap.$dist.ok

  if [ ! -f $okfile ]; then
    checksum_dist $dist || fetch $MIRROR/$REMOTE_PATH/$dist
  fi
}

function post_processing {
  if [ -d $MOUNTPOINT/etc ]; then
    [ ! -f $MOUNTPOINT/etc/resolv.conf ] && \
      cp /etc/resolv.conf $MOUNTPOINT/etc/resolv.conf
  fi
}

cd $TMPDIR || exit 3

fetch $MIRROR/$REMOTE_PATH/MANIFEST
<% @dists.each do |dist| %>
fetch_dist <%= dist %>
checksum_dist <%= dist %> && install_dist <%= dist %> || exit 3
<% end %>

post_processing
